<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>Thêm laptop</title>
  <link rel="stylesheet" th:href="@{/assets/css/admin/pages/laptop/create.css}">
  <link rel="stylesheet" th:href="@{/assets/css/admin/fragments/nav-side.css}">
  <link rel="stylesheet" th:href="@{/assets/css/admin/fragments/nav-top.css}">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <script src="https://unpkg.com/dropzone@6.0.0-beta.1/dist/dropzone-min.js"></script>
  <link href="https://unpkg.com/dropzone@6.0.0-beta.1/dist/dropzone.css" rel="stylesheet" type="text/css" />
</head>

<body>
  <div class="main-container">
    <div th:replace="admin/fragments/nav-side :: nav-side"></div>
    <div th:replace="admin/fragments/nav-top :: nav-top"></div>
    <div class="page-container">
      <div class="page-header">
        <div class="header-content">
          <h1>Admin /</h1>
          <h1>Quản lý laptop</h1>
        </div>
      </div>
      <div class="dashboard-header">
        <div class="dashboard-title">
          <h1>Tạo laptop mới</h1>
        </div>
      </div>
      <div class="page-content">
        <div class="form-header">
          <span class="material-symbols-outlined">list_alt</span>
          <p>Form</p>
        </div>
        <form th:action="@{/admin/laptop/create}" th:object="${laptop}" method="POST" enctype="multipart/form-data"
          class="form-container">
          <div class="grid grid-cols-12 gap-4 mt-4">

            <div class="col-span-12">
              <div class="input-contain">
                <label for="name" class="block mb-1 font-medium">Tên laptop</label>
                <div class="input-content flex space-x-2 items-center border border-gray-300 rounded-md">
                  <span class="material-symbols-outlined">laptop</span>
                  <input type="text" th:field="*{name}" id="name" placeholder="Nhập tên laptop"
                    class="w-full border border-none outline-none rounded-md p-2" required>
                </div>
              </div>
            </div>

            <div class="col-span-12">
              <div class="input-contain">
                <label for="modelId" class="block mb-1 font-medium">Mã model</label>
                <div class="input-content flex space-x-2 items-center border border-gray-300 rounded-md">
                  <span class="material-symbols-outlined">view_in_ar</span>
                  <select th:field="*{model.id}" id="modelId"
                    class="w-full border border-none outline-none rounded-md p-2" required>
                    <option value="" disabled selected>Chọn mã model</option>
                    <option th:each="model : ${models}" th:value="${model.id}" th:text="${model.name}"></option>
                  </select>
                </div>
              </div>
            </div>

            <div class="col-span-12">
              <div class="input-contain">
                <label for="warrantyPeriod" class="block mb-1 font-medium">Bảo hành</label>
                <div class="input-content flex space-x-2 items-center border border-gray-300 rounded-md">
                  <span class="material-symbols-outlined">verified</span>
                  <select th:field="*{warrantyPeriod}" id="warrantyPeriod"
                    class="w-full border border-none outline-none rounded-md p-2" required>
                    <option value="" disabled selected>Chọn thời hạn bảo hành</option>
                    <option value="1">1 năm</option>
                    <option value="2">2 năm</option>
                    <option value="3">3 năm</option>
                    <option value="4">4 năm</option>
                    <option value="5">5 năm</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="col-span-12">
              <div class="input-contain">
                <label for="imgUrl" class="block mb-1 font-medium">URL hình ảnh</label>
                <div class="input-content flex space-x-2 items-center border border-gray-300 rounded-md">
                  <span class="material-symbols-outlined">image</span>
                  <input type="url" th:field="*{imgUrl}" id="imgUrl" placeholder="Nhập URL hình ảnh"
                    class="w-full border border-none outline-none rounded-md p-2">
                </div>
              </div>
            </div>
          </div>

          <div class="btn-container flex space-x-4 mt-4">
            <button type="submit" class="confirm-btn">Thêm laptop</button>
            <a href="/admin/laptop" class="cancel-btn"
              style="display: inline-block; text-align: center; text-decoration: none;">Hủy</a>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script th:src="@{/assets/js/admin/script.js}"></script>
  <script>
    Dropzone.autoDiscover = false;

    let uploadedImageUrls = [];

    const myDropzone = new Dropzone("#imageUploadForm", {
      url: "/upload",
      maxFilesize: 2,
      acceptedFiles: "image/*",
      addRemoveLinks: true,
      dictDefaultMessage: "Kéo và thả ảnh vào đây hoặc nhấn để chọn",
      dictRemoveFile: "Xóa",
      // ****** THÊM DÒNG NÀY VÀO ĐÂY ******
      previewsContainer: "#dropzone-preview", // Chỉ định nơi ảnh preview sẽ hiển thị

      init: function () {
        // Dropzone.js tự động ẩn thông báo mặc định khi có file.
        // Nếu bạn muốn kiểm soát hiển thị thông báo "Kéo và thả ảnh vào đây"
        // (ví dụ: ẩn nó hoàn toàn hoặc di chuyển nó), bạn có thể thêm logic ở đây.
        // Thông thường, bạn sẽ đặt div dz-message trực tiếp trong form,
        // và Dropzone sẽ quản lý nó.

        this.on("success", function (file, response) {
          console.log("Ảnh đã được tải lên thành công:", response);
          uploadedImageUrls.push(response);
          file.uploadedFileName = response; // gán tên ảnh cho file (phòng khi cần)
          updateImageCount();
        });

        this.on("removedfile", function (file) {
          const name = file.uploadedFileName;
          uploadedImageUrls = uploadedImageUrls.filter(url => url !== name);
          updateImageCount();
        });
      }
    });

    function updateImageCount() {
      const images = myDropzone.files.length;
      const imageCount = document.getElementById("imageCount");
      if (images > 0) {
        imageCount.textContent = `Đã tải lên ${images} ảnh`;
        imageCount.classList.remove("text-gray-500", "italic");
      } else {
        imageCount.textContent = "Chưa có ảnh nào";
        imageCount.classList.add("text-gray-500", "italic");
      }
    }

    document.getElementById("confirmButton").addEventListener("click", function (e) {
      e.preventDefault();

      const vehicleData = {
        vehicleName: document.getElementById("vehicleName").value,
        brand: document.getElementById("brand").value,
        price: parseFloat(document.getElementById("price").value),
        licensePlate: document.getElementById("licensePlate").value,
        description: document.getElementById("description").value,
        imageUrls: uploadedImageUrls // Gửi mảng tên ảnh về backend
      };

      fetch("/create", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(vehicleData)
      })
        .then(response => response.text())
        .then(data => {
          alert(data);
          // Optionally reload or redirect
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Có lỗi xảy ra khi tạo laptop.');
        });
    });
  </script>



</body>

</html>